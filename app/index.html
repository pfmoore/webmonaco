<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="img/webmonaco-favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monaco - A Web-based probability calculator</title>
  <style>
    :root {
      --bg-color: #2c3e50;
      --panel-bg: #34495e;
      --input-bg: #3b5770;
      --text-color: #ecf0f1;
      --highlight: #3498db;
      --error: #b34040;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: sans-serif;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    header {
      background: var(--bg-color);
      color: var(--text-color);
      padding: 0.25rem;
      text-align: center;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
      width: 100%;
    }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* fixed 3 columns */
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    .option-item {
      background: var(--input-bg);
      padding: 0.25rem;
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .option-item input[type="checkbox"] {
      accent-color: var(--highlight);
    }

    .inputs-row {
      display: flex;
      flex-direction: column;
      gap: 1.2rem;
      margin-bottom: 1rem;
    }

    .inputs-row label {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      /* font-weight: bold; */
      font-weight: normal;      /* changed from bold */
      font-size: 0.95rem;       /* slightly smaller */
      color: var(--text-color); /* same as body text */
    }

    .inputs-row input[type="text"],
    .inputs-row input[type="number"],
    .inputs-row textarea {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #666;
      border-radius: 4px;
      background: var(--input-bg);
      color: var(--text-color);
    }

    .inputs-row textarea {
      resize: vertical;
      min-height: 4em;
    }

    .buttons-row {
      margin-bottom: 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .buttons-row button,
    .buttons-row .button-link {
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
      background-color: #3e5771;
      color: var(--text-color);
      border: 1px solid #7f8c8d;
      border-radius: 2px;
      box-shadow: inset 0 0 0 1px #1c2833;
      transition: background 0.2s, box-shadow 0.2s;
      text-decoration: none;
    }

    .buttons-row button:hover,
    .buttons-row .button-link:hover {
      background-color: #486582;
    }

    .buttons-row button:active,
    .buttons-row .button-link:active {
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
    }

    @media (max-width: 600px) {
      /* Don't switch to one-per-line for buttons.
       * I'm not sure what the logic is for doing so, but
       * it wastes valuable screen space.
       */
      /*
      .buttons-row {
        flex-direction: column;
      }
      */

      .options-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 300px) {
      .options-grid {
        grid-template-columns: repeat(1, 1fr);
      }
    }

    .tab-container {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid color-mix(in srgb, var(--input-bg) 60%, white);
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 2px 6px color-mix(in srgb, var(--input-bg) 70%, black);
    }

    .tab-header {
      display: flex;
      border-bottom: 1px solid color-mix(in srgb, var(--input-bg) 60%, white);
      background-color: color-mix(in srgb, var(--input-bg) 90%, black);
    }

    .tab-header button {
      color: var(--text-color);
      flex: 1;
      padding: 10px;
      border: none;
      background: none;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }

    .tab-header button:hover {
      background-color: color-mix(in srgb, var(--input-bg) 70%, white);
    }

    .tab-header button.active {
      background-color: color-mix(in srgb, var(--input-bg) 60%, white);
      color: var(--text-color);
      border-bottom: 2px solid color-mix(in srgb, var(--text-color) 60%, var(--input-bg));
    }

    .tab-content {
      padding-left: 1em;
    }

    .tab-content pre {
      display: none;
      background: var(--input-bg);
      color: var(--text-color);
      margin-bottom: 1rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.95rem;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .tab-content pre.active {
      display: block;
    }

    .tab-content pre.error {
      color:var(--error);
    }

    </style>
  <script>
    const submit_calculation = async () => {
        options = Array.from(document.getElementById("checkboxes").getElementsByTagName("input"))
            .filter(c => c.checked)
            .map(c => c.value)
        opt = document.getElementById("options").value;
        if (opt) { options.push(opt); }
        expr = document.getElementById("expression").value;
        number = document.getElementById("number").value;
        body = {};
        if (options) { body.options = options;}
        if (expr) { body.expr = expr;}
        if (number) { body.number = number;}
        if (number && !expr) {
            alert("Must supply an expression if you give a number of evaluations")
            return
        }

        document.getElementById('progress').textContent = "Sent request to Monaco";
        // Update the warning if no response after 1 minute
        var alert_id = setTimeout(() => {
          document.getElementById('progress').textContent = "Request is taking too long - may have crashed...";
        }, 60000)
        const response = await fetch('https://webmonaco.fly.dev/run', {
            method: "POST",
            body: JSON.stringify(body),
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const myJson = await response.json(); //extract JSON from the http response
        clearTimeout(alert_id);
        document.getElementById('progress').textContent = "";
        console.log(myJson)
        const div_out = document.getElementById('stdout');
        div_out.textContent = myJson.out.content.replace(/^\n*|\n*$/g, '');
        const div_err = document.getElementById('stderr');
        div_err.textContent = myJson.err.content.replace(/^\n*|\n*$/g, '');
        document.getElementById('command').textContent = myJson.command.replace(/^\n*|\n*$/g, '');
        if (myJson.err.content) {
          selectTab("stderr");
        } else {
          selectTab("stdout");
        }
        var notifications = [];
        if (myJson.status == "Timeout") {
          notifications.push("Monaco ran for too long and was terminated");
        }
        if (myJson.out.truncated) {
          notifications.push("Monaco output was too long and was truncated");
        }
        if (myJson.err.truncated) {
          notifications.push("Monaco produced too many errors - the output was truncated");
        }
        if (notifications.length > 0) {
          var n = document.getElementById('notifications');
          n.textContent = notifications.join("<br>");
        }
        else {
          document.getElementById('notifications').className = "hidden";
        }
    }

    function deselect_sibling(me, sibling) {
        if (me.checked) {
            document.getElementById(sibling).checked = false;
        }
    }

    function clear_output() {
        document.getElementById('progress').textContent = "";
        document.getElementById('stdout').textContent = "Program output appears here";
        document.getElementById('stderr').textContent = "Errors and warnings appear here";
        document.getElementById('stderr').className = "";
        document.getElementById('command').textContent = "Command file appears here";
    }

    function initialise() {
      var sp = new URLSearchParams(document.location.search)
      const selected = sp.getAll("checkbox")
      // Loop through all checkboxes in the grid
      document.querySelectorAll('.options-grid input[type="checkbox"]').forEach(cb => {
        // Get the label text associated with the checkbox
        const labelText = cb.parentElement.textContent.trim();

        // If the label text is in the selected array, check the box
        if (selected.includes(labelText)) {
          cb.checked = true;
        }
      });
      document.getElementById('options').value = sp.get("options");
      document.getElementById('expression').value = sp.get("expression");
      document.getElementById('number').value = sp.get("number");

      if (sp.has("execute")) submit_calculation();
    }
  </script>
</head>
<body>
  <header>
    <h2>Welcome to Monaco!</h2>
  </header>

  <div class="container">

    <!-- Checkbox Options Grid -->
    <div class="options-grid" id="checkboxes">
      <div class="option-item">
        <label><input type="checkbox" id="-exact" value="-exact" onclick="deselect_sibling(this, '-new')"/> -exact</label>
        <label><input type="checkbox" id="-new" value="-new" onclick="deselect_sibling(this, '-exact')"/> -new</label>
      </div>
      <div class="option-item">
        <label><input type="checkbox" id="-statistics" value="-statistics" onclick="deselect_sibling(this, '+statistics')"/> -statistics</label>
        <label><input type="checkbox" id="+statistics" value="+statistics" onclick="deselect_sibling(this, '-statistics')"/> +statistics</label>
      </div>
      <div class="option-item"><label><input type="checkbox" value="-table" /> -table</label></div>
      <div class="option-item"><label><input type="checkbox" value="-histogram" /> -histogram</label></div>
      <div class="option-item"><label><input type="checkbox" value="-cumulative" /> -cumulative</label></div>
      <div class="option-item"><label><input type="checkbox" value="-rcumulative" /> -rcumulative</label></div>
      <div class="option-item"><label><input type="checkbox" value="-probability" /> -probability</label></div>
      <div class="option-item"><label><input type="checkbox" value="-percent" /> -percent</label></div>
      <div class="option-item"><label><input type="checkbox" value="-version -size +date" /> Program Info</label></div>
    </div>

    <!-- Input Fields with Labels -->
    <div class="inputs-row">
      <label>
        Options
        <input type="text" id="options" placeholder="Options" />
      </label>

      <label>
        Expression
        <textarea id="expression" placeholder="Expression"></textarea>
      </label>

      <label>
        Number
        <input id="number" type="text" placeholder="Number" />
      </label>
  </div>
  
  <!-- Buttons -->
  <div class="buttons-row">
    <button onclick="submit_calculation()">Calculate</button>
    <button onclick="clear_output()">Clear</button>
    <a class="button-link" id="checkboxLink" href="" target="_blank">Calculation Link</a>
    <a class="button-link" href="https://webmonaco.fly.dev/help" target="_blank">Help</a>
  </div>

  <!-- Output Areas -->
  <div id="progress" class=""></div>
  <div id="notifications" class="hidden"></div>

  <div class="tab-container">
    <div class="tab-header">
      <button class="tab-btn active" data-target="stdout">Output</button>
      <button class="tab-btn" data-target="stderr">Errors</button>
      <button class="tab-btn" data-target="command">Command</button>
    </div>
    <div class="tab-content">
      <pre class="output active" id="stdout">Program output appears here</pre>
      <pre class="output error" id="stderr">Errors and warnings appear here</pre>
      <pre class="output" id="command">Command file appears here</pre>
    </div>
  </div>

  <script>
    const buttons = document.querySelectorAll('.tab-btn');
    const panes = document.querySelectorAll('.tab-content pre');

    buttons.forEach(btn => {
      btn.addEventListener('click', () => selectTab(btn.dataset.target));
    });

    // Function to programmatically select a tab by name
    function selectTab(name) {
      const btn = document.querySelector(`.tab-btn[data-target="${name}"]`);
      const pane = document.getElementById(name);

      if (!btn || !pane) {
        console.warn(`Tab "${name}" not found.`);
        return;
      }

      // Deactivate all tabs and panes
      buttons.forEach(b => b.classList.remove('active'));
      panes.forEach(p => p.classList.remove('active'));

      // Activate the selected tab
      btn.classList.add('active');
      pane.classList.add('active');
    }

    initialise();

  </script>
  <script>
    const baseURL = window.location.href.split('?')[0];
    const checkboxes = document.querySelectorAll('.options-grid input[type="checkbox"]');
    const link = document.getElementById('checkboxLink');

    function make_url() {
      const params = new URLSearchParams();

      // Handle the fixed fields
      ["options", "expression", "number"]
          .map(el => [el, document.getElementById(el).value])
          .filter(ev => ev[1])
          .forEach(ev => params.append(ev[0], ev[1]));

      // Get all checked checkboxes and extract their values
      const checkedValues = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.parentElement.textContent.trim());
      checkedValues.forEach(v => params.append('checkbox', v));

      return baseURL + (params.size ? '?' + params.toString() : '');
    }

    function updateLink() {
      // Update the linkâ€™s href
      const fullURL = make_url();
      link.href = fullURL;
    }

    // Attach event listeners to all checkboxes
    checkboxes.forEach(cb => cb.addEventListener('change', updateLink));

    ["options", "expression", "number"]
      .map(el => document.getElementById(el))
      .forEach(el => el.addEventListener('change', updateLink));

    // Initialize link on page load
    updateLink();
  </script>
</body>
</html>
